<!DOCTYPE html>
<html>
<head>
    <title>Dashboard - WhatsApp Service</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        #qr-container, #message-container { text-align: center; margin: 20px 0; }
        #qr-code { margin: 20px auto; }
        button { padding: 10px 20px; background: #25D366; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:disabled { background: #cccccc; }
        .hidden { display: none; }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .ready { background: #d4edda; color: #155724; }
        .waiting { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h2>WhatsApp Dashboard</h2>
    <div>
        <button onclick="logout()" style="float: right;">Logout</button>
        <div id="user-info"></div>
    </div>

    <div id="qr-container" class="hidden">
        <h3>Scan QR Code to Connect WhatsApp</h3>
        <div id="qr-code"></div>
        <p>Scan this QR code with your WhatsApp phone app</p>
    </div>

    <div id="message-container" class="hidden">
        <h3>Send Test Message</h3>
        <button onclick="sendMessage()" id="send-btn">Send "Hello World" Message</button>
        <div id="message-status"></div>
    </div>

    <div id="status-container" class="status"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/';

        async function checkStatus() {
            const response = await fetch('/api/whatsapp/status', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            
            const statusDiv = document.getElementById('status-container');
            statusDiv.textContent = `Status: ${data.status}`;
            statusDiv.className = `status ${data.whatsappReady ? 'ready' : 'waiting'}`;

            if (data.firstLogin || !data.whatsappReady) {
                document.getElementById('qr-container').classList.remove('hidden');
                document.getElementById('message-container').classList.add('hidden');
                if (data.status === 'qr_waiting') {
                    await getQRCode();
                }
            } else {
                document.getElementById('qr-container').classList.add('hidden');
                document.getElementById('message-container').classList.remove('hidden');
            }
        }

        async function getQRCode() {
            const response = await fetch('/api/whatsapp/qr', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            if (data.qrCode) {
                QRCode.toCanvas(document.getElementById('qr-code'), data.qrCode, function(error) {
                    if (error) console.error(error);
                });
            }
        }

        async function sendMessage() {
            const btn = document.getElementById('send-btn');
            btn.disabled = true;
            btn.textContent = 'Sending...';
            
            const response = await fetch('/api/whatsapp/send-message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            
            document.getElementById('message-status').textContent = 
                data.status === 'success' ? 'Message sent successfully!' : `Error: ${data.error}`;
            
            btn.disabled = false;
            btn.textContent = 'Send "Hello World" Message';
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }

        // Check status every 3 seconds
        setInterval(checkStatus, 3000);
        checkStatus();
    </script>
</body>
</html>
